<!DOCTYPE html>
<html lang="en">
<body>
    {% include 'header.html' %}
    <div class="calendar-box">
        {% set dates = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
        {% for isoweekday in range(7) %}
            <div class="day">
                {% if (weekday + isoweekday) % 7 == weekday %}
                    <p class="weekday-calendar">{{ dates[(weekday + isoweekday) % 7] }} (Today)</p>
                {% else %}
                    <p class="weekday-calendar">{{ dates[(weekday + isoweekday) % 7] }}</p>
                {% endif %}
                <div class="{{ dates[(weekday + isoweekday) % 7] }} outfit-action-button" id="{{ dates[(weekday + isoweekday) % 7] }}" ondrop="drop(event, '{{ dates[(weekday + isoweekday) % 7] }}')" ondragover="allowDrop(event)">
                    {% if calendarInfo and dates[(weekday + isoweekday) % 7] in calendarInfo %}
                        {% for outfitType, imagePaths in calendarInfo[dates[(weekday + isoweekday) % 7]].items() %}
                            <div class="grid" draggable="true" ondragstart="drag(event)">
                                <div class="grid-item text">
                                    <h2 class="title-text">
                                        {{ outfitType }}
                                    </h2>
                                    <div class="clothing-items">
                                        {% for image_path in imagePaths %}
                                            <div class="clothing-item">
                                                {% if config == "local" %}
                                                    <img class="outfit-grid-image" src="{{ url_for('static', filename=image_path) }}" alt="{{ clothing }} Image" draggable="false">
                                                {% else %}
                                                    <img class="outfit-grid-image" src="{{ url_for(image_path) }}" alt="Clothing Image" draggable="false">
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                        <br>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <span>Drag outfit here</span>
                    {% endif %}
                    <center>
                        <button class="clear-button" onclick="clearDay('{{ dates[(weekday + isoweekday) % 7] }}')">Clear Day</button>
                    </center>
                </div>
            </div>
        {% endfor %}
    </div>
    
    <main>
        <h1 class="center-container title">Outfits</h1>
        <div class="outfit-container">
            {% for outfit in outfits %}
                <div class="grid" draggable="true" ondragstart="drag(event)">
                    <div class="grid-item text">
                        <div class="clothing-items">
                            <h2 class="title-text">
                                {{ outfit[0] }}
                            </h2>
                            {% for clothing_name, image_path, clothes_id in outfit[1:] %}
                                <div class="clothing-item" clothing-name="{{ clothing_name }}" clothing-id="{{ clothes_id }}">
                                    {% if config == "local" %}
                                        <img class="outfit-grid-image" src="{{ url_for('static', filename=image_path) }}" alt="{{ clothing }} Image" draggable="false">
                                    {% else %}
                                        <img class="outfit-grid-image" src="{{ url_for(image_path) }}" alt="Clothing Image" draggable="false">
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>  
    </main>
</div>
    <script>
        function clearDay(dayId) {
            var dayElement = document.getElementById(dayId);
            console.log(dayId);
            var outfit = dayElement.querySelector('.grid');
            console.log(outfit);
            console.log("OUTFIT PRESENT")
                // Retrieve outfit content
                var outfitContent = outfit.innerHTML;

                // Remove outfit from the day grid
                dayElement.removeChild(outfit);

                // Parse the HTML content to extract necessary information
                var tempDiv = document.createElement('div');
                tempDiv.innerHTML = outfitContent;

                var outfitTitle = tempDiv.querySelector('.text h2').innerText.trim();
                var imageElements = tempDiv.querySelectorAll('.clothing-item img');
                var imagePaths = Array.from(imageElements).map(img => img.getAttribute('src'));

                // Construct HTML structure for the outfit
                var reconstructedOutfit = document.createElement('div');
                reconstructedOutfit.className = 'grid';
                reconstructedOutfit.draggable = true; // Make the entire grid draggable
                reconstructedOutfit.ondragstart = drag; // Assign the drag event
                var outfitItem = document.createElement('div');
                outfitItem.className = 'grid-item text';
                var outfitHeader = document.createElement('h2');
                outfitHeader.className = 'text';
                outfitHeader.textContent = outfitTitle;
                var clothingItems = document.createElement('div');
                clothingItems.className = 'clothing-items';
                //pass these to flask by post request
                imagePaths.forEach(imagePath => {
                    var clothingItem = document.createElement('div');
                    clothingItem.className = 'clothing-item';
                    var image = document.createElement('img');
                    image.className = 'outfit-grid-image';
                    image.src = imagePath;
                    image.draggable = false; // Disable dragging for images
                    clothingItem.appendChild(image);
                    clothingItems.appendChild(clothingItem);
                });

                outfitItem.appendChild(outfitHeader);
                outfitItem.appendChild(clothingItems);
                reconstructedOutfit.appendChild(outfitItem);

                // Append reconstructed outfit to the outfit-container
                var outfitContainer = document.querySelector('.outfit-container');
                outfitContainer.appendChild(reconstructedOutfit);
                var dayElement = document.getElementById(dayId);
                var clearButton = dayElement.querySelector('.clear-button');
                clearButton.style.display = 'none';
                console.log("CLEAR DAY DAYOFWEEK: ", dayId);
                console.log("CLEAR DAY IMAGEPATHS: ", imagePaths);
                console.log("CLEAR DAY OUTFIT TITLE: ", outfitTitle);
                var outfitData = {
                    day_of_week: dayId,
                    image_paths: imagePaths,
                    outfitType: outfitTitle
                };
                var newSpan = document.createElement('span');
                newSpan.textContent = 'Drag outfit here'; // Set the text content;
            if (outfit) {
                
                return new Promise((resolve) => {
                    

                    // Perform asynchronous operations inside the promise
                    fetch('/delete_outfit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(outfitData)
                    })
                    .then(response => {
                        if (response.ok) {
                            console.log('Outfit data to DELETE sent successfully.');
                            resolve(); // Resolve the promise when deletion is successful
                        } else {
                            throw new Error('Failed to delete outfit data.');
                        }
                    })
                    .catch(error => {
                        console.error('Error while deleting outfit data:', error);
                        // Handle any error scenarios for deletion
                    });
                });
            }
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        let draggedOutfit = null;

        function drag(event) {
            event.dataTransfer.setData("text", event.target.id);

            // Get the clothing associated with the dragged outfit
            var outfit = event.target.closest('.grid');
            var clothing = outfit.querySelector('.text h2').innerText.trim();

            // Get all the image paths associated with the dragged outfit
            var imageElements = outfit.querySelectorAll('.clothing-item img');
            var imagePaths = Array.from(imageElements).map(img => img.getAttribute('src'));

            var clothingDivs = outfit.querySelectorAll('.clothing-items .clothing-item');
            var clothingIds = Array.from(clothingDivs).map(div => div.getAttribute('clothing-id'));

            // Set custom data attributes for the dragged outfit
            event.dataTransfer.setData("clothing", clothing);
            event.dataTransfer.setData("imagePaths", JSON.stringify(imagePaths));
            event.dataTransfer.setData("clothesIds", JSON.stringify(clothingIds));
            console.log(clothing)
            console.log(imagePaths)
            console.log(clothingIds)
            draggedOutfit = event.target;
        }

        function toggleClearButton(dayId, show) {
            var dayElement = document.getElementById(dayId);
            var clearButton = dayElement.querySelector('.clear-button');

            // Check if clothing items exist within the day element
            var clothingItemsExist = dayElement.querySelector('.clothing-items');

            // Show the clear button if clothing items exist, else show based on the provided argument 'show'
            clearButton.style.display = clothingItemsExist ? 'block' : show ? 'block' : 'none';
        }

        // Call this function after the DOM is loaded to initially hide the buttons
        document.addEventListener('DOMContentLoaded', function () {
            toggleClearButton('monday', false);
            toggleClearButton('tuesday', false);
            toggleClearButton('wednesday', false);
            toggleClearButton('thursday', false);
            toggleClearButton('friday', false);
            toggleClearButton('saturday', false);
            toggleClearButton('sunday', false);
        });

        async function drop(event, day) {
            var imagePaths = JSON.parse(event.dataTransfer.getData("imagePaths"));
            console.log("drop imagePaths: ", imagePaths);

            var clothes_ids = JSON.parse(event.dataTransfer.getData("clothesIds"))
            console.log(clothes_ids)

            event.preventDefault();
            console.log("in drop", day);
            var dayElement = document.getElementById(day);
            var clothingItemsExist = dayElement.querySelector('.clothing-items');
            var clothing = event.dataTransfer.getData("clothing");
            var imagePaths = JSON.parse(event.dataTransfer.getData("imagePaths"));
            
            console.log("drop clothing: ", clothing);
            console.log("drop imagePaths: ", imagePaths);

            var outfit = document.createElement('div');
            outfit.className = 'grid';

            var outfitContent = document.createElement('div');
            outfitContent.className = 'grid-item text';

            var outfitTitle = document.createElement('h2');
            outfitTitle.className = 'text';
            outfitTitle.textContent = clothing;

            var clothingItems = document.createElement('div');
            clothingItems.className = 'clothing-items';

            let i = 0;
            imagePaths.forEach(imagePath => {
                var clothingItem = document.createElement('div');
                clothingItem.className = 'clothing-item';
                clothingItem.setAttribute('clothing-id', clothes_ids[i]);
                i++;
                var image = document.createElement('img');
                image.className = 'outfit-grid-image';
                image.src = imagePath;
                clothingItem.appendChild(image);
                clothingItems.appendChild(clothingItem);
            });

            outfitContent.appendChild(outfitTitle);
            outfitContent.appendChild(clothingItems);
            outfit.appendChild(outfitContent);
            outfitContent.style.backgroundColor = 'white';
            outfit.style.backgroundColor = 'white';

            dayElement.appendChild(outfit);

            draggedOutfit.style.display = 'none';
            toggleClearButton(day, true);



            // Create an object with the day and image paths data
            var outfitData = {
                day_of_week: day,
                clothes_id: clothes_ids,
                image_paths: imagePaths,
                outfitType: clothing
            };

            // this code handles the replacement for the outfits if another outfit is dragged on top
            if (clothingItemsExist) {
                console.log("Clothing items exist within dayElement.");
                await clearDay(day)
                console.log("PLS")

            } else {
                console.log("No clothing items found within dayElement.");
            }
            

            // Send the outfit data to Flask using fetch
            fetch('/save_outfit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(outfitData)
            })
            .then(response => {
                if (response.ok) {
                    console.log('Outfit data to SAVE sent successfully.');
                    // Handle any success actions if needed
                } else {
                    throw new Error('Failed to send outfit data.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Handle any error scenarios
            });
                }
    </script>
    {% include 'footer.html' %}
</body>
</html>